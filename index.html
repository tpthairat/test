<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PhoneShop + Admin (Firebase + Google Drive Image)</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏¥‡πà‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .scrollx { overflow-x: auto; }
    .hidden-el { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-3 py-3 flex items-center gap-3">
      <div class="text-xl font-bold">üì± PhoneShop</div>
      <nav class="ml-auto flex gap-2">
        <button id="nav-store" class="px-3 py-1 rounded-full hover:bg-gray-100">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
        <button id="nav-admin" class="px-3 py-1 rounded-full hover:bg-gray-100">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
        <span id="userBadge" class="px-2 py-1 text-sm rounded-full bg-gray-100 hidden-el"></span>
        <button id="btnLogin" class="px-3 py-1 rounded-md bg-black text-white">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        <button id="btnLogout" class="px-3 py-1 rounded-md bg-gray-200 hidden-el">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô -->
    <section id="page-store">
      <div class="mb-4 flex flex-wrap items-center gap-3">
        <h2 class="text-2xl font-semibold">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∏‡πà‡∏ô, ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå)" class="border rounded-md px-3 py-2 w-full sm:w-80" />
        <select id="brandFilter" class="border rounded-md px-3 py-2">
          <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>
        </select>
        <select id="sortPrice" class="border rounded-md px-3 py-2">
          <option value="">‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤</option>
          <option value="asc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡πÑ‡∏õ‡∏™‡∏π‡∏á</option>
          <option value="desc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≥</option>
        </select>
      </div>
      <div id="storeList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô -->
    <section id="page-admin" class="hidden-el">
      <div class="flex items-center gap-3 mb-3">
        <h2 class="text-2xl font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Admin)</h2>
        <span id="adminBadge" class="text-sm bg-emerald-100 text-emerald-700 px-2 py-1 rounded hidden-el">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
      </div>

      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
      <div class="grid lg:grid-cols-2 gap-4">
        <form id="productForm" class="bg-white rounded-2xl shadow p-4 space-y-3">
          <input type="hidden" id="docId" />
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô *</label>
              <input id="name" class="w-full border rounded-md px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå *</label>
              <input id="brand" class="w-full border rounded-md px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) *</label>
              <input id="price" type="number" min="0" step="1" class="w-full border rounded-md px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm">‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
              <input id="stock" type="number" min="0" step="1" class="w-full border rounded-md px-3 py-2" />
            </div>
          </div>
          <div>
            <label class="block text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏™‡πÄ‡∏õ‡∏Å/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)</label>
            <textarea id="desc" rows="3" class="w-full border rounded-md px-3 py-2"></textarea>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Google Drive URL ‡∏´‡∏£‡∏∑‡∏≠ direct URL)*</label>
              <input id="imageUrl" class="w-full border rounded-md px-3 py-2" placeholder="‡πÅ‡∏õ‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Drive ‡πÑ‡∏î‡πâ" required />
              <div class="flex gap-2 mt-2">
                <button type="button" id="btnConvertDrive" class="px-3 py-1 rounded-md bg-indigo-600 text-white">‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Drive ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ</button>
                <button type="button" id="btnTestPreview" class="px-3 py-1 rounded-md bg-gray-200">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ</button>
              </div>
              <p class="text-xs text-gray-600 mt-1">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ Google Drive: ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô "‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡πÑ‡∏î‡πâ" ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏≤‡πÅ‡∏õ‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</p>
            </div>
            <div class="flex items-start">
              <img id="preview" class="rounded-xl w-full object-cover max-h-48 border" alt="preview" />
            </div>
          </div>

          <div class="flex gap-2">
            <button class="px-4 py-2 rounded-md bg-black text-white" id="btnSave" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="px-4 py-2 rounded-md bg-gray-200" type="reset" id="btnReset">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          </div>
        </form>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="mb-2 flex items-center gap-2">
            <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô" class="border rounded-md px-3 py-2 w-full" />
          </div>
          <div class="scrollx">
            <table class="min-w-[640px] w-full text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th class="text-left p-2">‡∏£‡∏π‡∏õ</th>
                  <th class="text-left p-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô</th>
                  <th class="text-left p-2">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</th>
                  <th class="text-right p-2">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                  <th class="text-right p-2">‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                  <th class="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="adminTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Dialog: Login -->
  <dialog id="dlgLogin" class="rounded-2xl p-0 w-96 max-w-[95vw]">
    <form method="dialog" class="p-4 border-b">
      <div class="text-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
    </form>
    <form id="loginForm" class="p-4 space-y-3">
      <div>
        <label class="block text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input id="loginPassword" type="password" class="w-full border rounded-md px-3 py-2" required />
      </div>
      <div class="text-xs text-gray-500">* ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô <code>admins</code> (‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</div>
      <div class="flex gap-2 justify-end">
        <button type="button" id="btnCloseLogin" class="px-3 py-2 rounded-md bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="px-3 py-2 rounded-md bg-black text-white">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </form>
  </dialog>

  <!-- Firebase SDK (Modular v10+) -->
  <script type="module">
    // üëâ 1) ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const firebaseConfig = {
     apiKey: "AIzaSyAmsiJelUN1V8C9mCC1Osy-uSZAuk3M7Lw",
  authDomain: "test-95403.firebaseapp.com",
  databaseURL: "https://test-95403-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-95403",
  storageBucket: "test-95403.firebasestorage.app",
  messagingSenderId: "30370027223",
  appId: "1:30370027223:web:be434cdf70770ea44f4292",
    };

    // üëâ 2) ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // üëâ 3) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ====== Utilities ======
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);

    const state = {
      products: [],
      user: null,
      isAdmin: false,
    };

    function formatPrice(n) {
      if (typeof n !== 'number') n = Number(n||0);
      return n.toLocaleString('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 });
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive -> direct preview (uc?export=view&id=...)
    function driveToDirect(url) {
      try {
        if (!url) return '';
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏õ‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡∏£‡∏ü‡πå‡πÅ‡∏ö‡∏ö file/d/<id>/view
        const m1 = url.match(/\/file\/d\/([\w-]+)\//);
        if (m1) return `https://drive.google.com/uc?export=view&id=${m1[1]}`;
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô id=xxxxx
        const m2 = url.match(/[?&]id=([\w-]+)/);
        if (m2) return `https://drive.google.com/uc?export=view&id=${m2[1]}`;
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà host ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        return url;
      } catch(e){
        console.warn('driveToDirect error', e);
        return url;
      }
    }

    // ====== UI: Nav ======
    const pageStore = $('#page-store');
    const pageAdmin = $('#page-admin');
    const btnNavStore = $('#nav-store');
    const btnNavAdmin = $('#nav-admin');
    const btnLogin = $('#btnLogin');
    const btnLogout = $('#btnLogout');
    const userBadge = $('#userBadge');
    const adminBadge = $('#adminBadge');

    function showPage(key){
      pageStore.classList.toggle('hidden-el', key !== 'store');
      pageAdmin.classList.toggle('hidden-el', key !== 'admin');
    }

    btnNavStore.addEventListener('click', ()=> showPage('store'));
    btnNavAdmin.addEventListener('click', ()=> showPage('admin'));

    // ====== Auth ======
    const dlgLogin = $('#dlgLogin');
    const loginForm = $('#loginForm');
    $('#btnCloseLogin').addEventListener('click', ()=> dlgLogin.close());

    btnLogin.addEventListener('click', ()=> dlgLogin.showModal());
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pw = $('#loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, pw);
        dlgLogin.close();
      } catch(err){
        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    btnLogout.addEventListener('click', ()=> signOut(auth));

    async function checkAdmin(uid){
      if (!uid) return false;
      const ref = doc(db, 'admins', uid);
      const snap = await getDoc(ref);
      return snap.exists() && !!snap.data().isAdmin;
    }

    onAuthStateChanged(auth, async (user)=>{
      state.user = user;
      state.isAdmin = false;
      if (user) {
        userBadge.textContent = user.email;
        userBadge.classList.remove('hidden-el');
        btnLogout.classList.remove('hidden-el');
        btnLogin.classList.add('hidden-el');
        const ok = await checkAdmin(user.uid);
        state.isAdmin = ok;
        adminBadge.classList.toggle('hidden-el', !ok);
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
        if (ok) showPage('admin');
      } else {
        userBadge.classList.add('hidden-el');
        btnLogout.classList.add('hidden-el');
        btnLogin.classList.remove('hidden-el');
        adminBadge.classList.add('hidden-el');
      }
      renderAdminTable();
      guardAdminUI();
    });

    function guardAdminUI(){
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á section ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      pageAdmin.querySelectorAll('input,textarea,button,select').forEach(el=>{
        el.disabled = !state.isAdmin && el.closest('#page-admin');
      });
      if (!state.isAdmin) {
        pageAdmin.classList.add('opacity-60');
      } else {
        pageAdmin.classList.remove('opacity-60');
      }
    }

    // ====== Firestore: Realtime products ======
    const colProducts = collection(db, 'products');
    onSnapshot(query(colProducts, orderBy('createdAt','desc')), (snap)=>{
      state.products = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
      fillBrandFilter();
      renderStore();
      renderAdminTable();
    });

    // ====== Store (‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô) ======
    const storeList = $('#storeList');
    const qInput = $('#q');
    const brandFilter = $('#brandFilter');
    const sortPrice = $('#sortPrice');

    function fillBrandFilter(){
      const brands = Array.from(new Set(state.products.map(p=> (p.brand||'').trim()).filter(Boolean)));
      const cur = brandFilter.value;
      brandFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>' + brands.map(b=>`<option value="${b}">${b}</option>`).join('');
      if (brands.includes(cur)) brandFilter.value = cur;
    }

    function renderStore(){
      const q = qInput.value.trim().toLowerCase();
      const brand = brandFilter.value;
      const order = sortPrice.value; // '', 'asc', 'desc'
      let arr = [...state.products];
      if (q) arr = arr.filter(p => (p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q));
      if (brand) arr = arr.filter(p => (p.brand||'') === brand);
      if (order === 'asc') arr.sort((a,b)=> (a.price||0) - (b.price||0));
      if (order === 'desc') arr.sort((a,b)=> (b.price||0) - (a.price||0));

      storeList.innerHTML = arr.map(p=> `
        <article class="bg-white rounded-2xl shadow p-3 flex flex-col">
          <div class="aspect-[4/3] overflow-hidden rounded-xl border">
            <img loading="lazy" src="${p.imageUrl||''}" alt="${p.name||''}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400?text=No+Image'" />
          </div>
          <div class="mt-3 flex-1">
            <div class="text-sm text-gray-500">${p.brand||''}</div>
            <h3 class="text-lg font-semibold">${p.name||''}</h3>
            <div class="mt-1 font-bold">${formatPrice(p.price||0)}</div>
            <p class="text-sm text-gray-600 mt-1">${(p.desc||'').slice(0,120)}${(p.desc||'').length>120?'...':''}</p>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="flex-1 px-3 py-2 rounded-md bg-black text-white">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏î‡πÇ‡∏°)</button>
          </div>
        </article>
      `).join('');
    }

    qInput.addEventListener('input', renderStore);
    brandFilter.addEventListener('change', renderStore);
    sortPrice.addEventListener('change', renderStore);

    // ====== Admin: Form & Table ======
    const productForm = $('#productForm');
    const btnSave = $('#btnSave');
    const btnReset = $('#btnReset');
    const adminTable = $('#adminTable');
    const adminSearch = $('#adminSearch');

    // ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß & ‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡∏£‡∏ü‡πå
    const imgInput = $('#imageUrl');
    const preview = $('#preview');
    $('#btnConvertDrive').addEventListener('click', ()=>{
      imgInput.value = driveToDirect(imgInput.value.trim());
      preview.src = imgInput.value;
    });
    $('#btnTestPreview').addEventListener('click', ()=>{
      preview.src = (imgInput.value || '').trim();
    });

    function resetForm(){
      productForm.reset();
      $('#docId').value = '';
      preview.removeAttribute('src');
      btnSave.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }

    btnReset.addEventListener('click', (e)=>{
      e.preventDefault();
      resetForm();
    });

    productForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!state.isAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      const payload = {
        name: $('#name').value.trim(),
        brand: $('#brand').value.trim(),
        price: Number($('#price').value || 0),
        stock: Number($('#stock').value || 0),
        desc: $('#desc').value.trim(),
        imageUrl: driveToDirect($('#imageUrl').value.trim()),
        updatedAt: serverTimestamp(),
      };
      const docId = $('#docId').value;
      try {
        if (!docId) {
          await addDoc(colProducts, { ...payload, createdAt: serverTimestamp() });
        } else {
          await updateDoc(doc(db, 'products', docId), payload);
        }
        resetForm();
      } catch(err){
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    function renderAdminTable(){
      const q = adminSearch.value.trim().toLowerCase();
      let arr = [...state.products];
      if (q) arr = arr.filter(p => (p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q));
      adminTable.innerHTML = arr.map(p=> `
        <tr class="border-b">
          <td class="p-2">
            <img src="${p.imageUrl||''}" class="w-16 h-12 object-cover rounded border" onerror="this.src='https://placehold.co/120x90?text=No+Image'"/>
          </td>
          <td class="p-2">${p.name||''}</td>
          <td class="p-2">${p.brand||''}</td>
          <td class="p-2 text-right">${formatPrice(p.price||0)}</td>
          <td class="p-2 text-right">${p.stock||0}</td>
          <td class="p-2">
            <div class="flex gap-2 justify-end">
              <button class="px-2 py-1 rounded bg-amber-100 hover:bg-amber-200" data-action="edit" data-id="${p.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="px-2 py-1 rounded bg-rose-100 hover:bg-rose-200" data-action="del" data-id="${p.id}">‡∏•‡∏ö</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    adminSearch.addEventListener('input', renderAdminTable);

    adminTable.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const p = state.products.find(x=> x.id === id);
      if (!p) return;
      if (action === 'edit'){
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
        $('#docId').value = p.id;
        $('#name').value = p.name||'';
        $('#brand').value = p.brand||'';
        $('#price').value = p.price||0;
        $('#stock').value = p.stock||0;
        $('#desc').value = p.desc||'';
        $('#imageUrl').value = p.imageUrl||'';
        preview.src = p.imageUrl||'';
        btnSave.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
        showPage('admin');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (action === 'del'){
        if (!state.isAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
        if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
          try {
            await deleteDoc(doc(db, 'products', id));
          } catch(err){
            alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
          }
        }
      }
    });

    // ====== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ======
    showPage('store');

  </script>

  <!--
  ======================= ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠ =======================

  1) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Firebase ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Authentication (Email/Password)
     - Firebase Console > Authentication > Sign-in method > ‡πÄ‡∏õ‡∏¥‡∏î Email/Password

  2) Firestore Database
     - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore (‡πÇ‡∏´‡∏°‡∏î Production)
     - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:
       - products (collection)
         - {autoId}: { name, brand, price, stock, desc, imageUrl, createdAt, updatedAt }
       - admins (collection)
         - {uid}: { isAdmin: true }

  3) ‡πÉ‡∏™‡πà firebaseConfig ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

  4) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Security Rules (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
     - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏é (‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô, ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô admins ‡πÅ‡∏•‡∏∞ isAdmin=true)

   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       // ‡πÉ‡∏Ñ‡∏£‡πÜ ‡∏Å‡πá‡∏≠‡πà‡∏≤‡∏ô products ‡πÑ‡∏î‡πâ
       match /products/{docId} {
         allow read: if true;
         allow write: if isAdmin();
       }

       // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ admins ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á uid ‡πÅ‡∏•‡∏∞ admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡πà‡∏ß)
       match /admins/{uid} {
         allow read: if request.auth != null && request.auth.uid == uid;
         allow write: if false; // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
       }

       function isAdmin() {
         return request.auth != null &&
           get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
       }
     }
   }

  5) ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive
     - ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive > ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ä‡∏£‡πå > ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡πÑ‡∏î‡πâ"
     - ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Drive ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ"
     - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: https://drive.google.com/uc?export=view&id=FILE_ID

  6) ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
     - ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏≠‡∏≤ uid (‡∏î‡∏π‡πÉ‡∏ô Authentication ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ) ‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô admins ‡∏î‡πâ‡∏ß‡∏¢ id=uid ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á isAdmin=true

  7) ‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏û‡∏•‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
     - ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (HTML+JS) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô GitHub Pages / Netlify)

  ======================================================================
  -->
</body>
</html>
